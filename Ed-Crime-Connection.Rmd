---
title: "The Education-Crime Connection"
subtitle: "A Data-Driven Analysis of the Philadelphia Public School System and Crime Rates"
author:
- Liam Smith
- Tyler Christianson
- Mitch Jeter
date: "March 2nd, 2025"
output:
  pdf_document:
    toc: true
    toc_depth: '4'
    number_sections: true
  html_document:
    code_folding: show
    highlight: haddock
    number_sections: true
    theme: lumen
    toc: true
    toc_depth: 4
    toc_float: true
urlcolor: blue
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = "hide", fig.width=8, fig.height=4)
options(scipen = 0, digits = 3)  # controls base R output
if(!require('pacman')) {install.packages('pacman')}
pacman::p_load(dplyr, ggmap, ggplot2, sf, mapview, knitr, lubridate, ggpubr, tidyr, fixest, sp, glmnet,
               caret, pROC, tidyverse)
```

```{r data load}
neighborhoods <- st_read('data/raw/philadelphia-neighborhoods.geojson') %>% 
  st_transform(4326)
crime <- read.csv('data/clean/crime-by-neighborhood.csv')
schools <- read.csv('data/clean/schools-by-neighborhood.csv')
```

\pagebreak

# Executive Summary

## Goal of the Study
The primary objective of this project is to explore and understand the relationship between the Philadelphia Public Schooling System and crime rates in the city of Philadelphia. The relationship between education and crime has long been a topic of interest for policymakers and researchers, as strong education systems are often associated with lower crime rates. This project aims to analyze the connection between the public school system and crime rates across the city, exploring how factors such as graduation rates influence crime patterns. By leveraging records from 2023 and various statistical and machine learning methods, this study seeks to uncover potential relationships and provide insights that could inform policy decisions geared towards improving both education and public safety in the city of Philadelphia.

Through data-driven analysis, this project will look into specific neighborhoods and evaluate the relationship between crime rates and the quality of public schools in the area. By identifying factors that contribute to this relationship, this study can serve as a potential foundation for discussions on how investments in education can serve as a proactive step towards crime prevention. 

## Data description

### OpenData Philly - Uncleaned Datasets

#### Crime Incidents Data
The Philadelphia Police Department provides and maintains a dataset of crime incidents in the city of Philadelphia going back to 2006. The dataset contains key information about each incident, including the police district it occured in, the date and time an officer was dispatched to the scene, the block that the incident occured on, and the type of crime that was committed. For the purposes of this study, the only year used was 2023.

#### School Department of Philadelphia Data
The School District of Philadelphia provides a variety of datasets regarding school performance. This study is based on the School Graduation Rates dataset, which is a longitudinal dataset containing the graduation rate by school broken out by graduation rate type, demographic category, and ninth grade cohort. Students are attributed to the last school that they attended if they did attend multiple schools. For the purposes of this study, the cohort that started high school in 2019 was used.

#### Neighborhood GeoJSON Data
The city of Philadelphia provides neighborhood boundaries for over 150 neighborhoods in the city. This dataset will be used for mapping and also for grouping schools and crime incidents by neighborhood.

### Team One Data - Cleaned Datasets

#### Crime Incidents by Neighborhood
This dataset contains crime incident records from 2023 categorized by neighborhood. It includes 162,032 entries, with attributes such as the date and time of the incident, crime classification, location details, and associated neighborhood. The dataset also includes unique identifiers, district and police service area, and geospatial information. This dataset will be used for analyzing crime trends, spatial distributions, and temporal patterns across neighborhoods.

#### School Data
This dataset contains information on school performance metrics for 79 schools. Each entry includes details such as the school year, unique school identifier, school name, and sector (sector, e.g., district or charter). It focuses on four year graduation rates. The dataset also includes numerical values for assessment, as well as geographical coordinates for spatial analysis. This dataset is useful for evaluating school performance trends and comparing graduation rates across different student populations.

# Exploratory data analysis (EDA)

## Exploring Philadelphia

Philadelphia, the largest city in Pennsylvania and the sixth-largest in the United States, is a historic and cultural hub known for its rich colonial heritage and vibrant modern identity. Founded in 1682 by William Penn, the city played a crucial role in the American Revolution and served as the nation's capital before Washington, D.C. Landmarks such as Independence Hall, where the Declaration of Independence and the U.S. Constitution were signed, and the Liberty Bell symbolize Philadelphia’s deep-rooted connection to American democracy. Beyond its historical significance, the city boasts world-class museums, including the Philadelphia Museum of Art — home to the famous “Rocky Steps” — as well as a thriving arts, music, and culinary scene that attracts millions of visitors each year.

Today, Philadelphia is a dynamic metropolis that balances tradition with innovation. It is home to leading universities such as the University of Pennsylvania and Temple University, contributing to its reputation as an educational and research powerhouse. The city’s economy is diverse, with strong sectors in healthcare, finance, and technology, alongside a passionate sports culture represented by teams like the Eagles, Phillies, Flyers, and 76ers. However, Philadelphia also faces challenges, including socioeconomic disparities, crime, and education system concerns. Despite these issues, the city remains resilient, with ongoing efforts to foster economic growth, community development, and urban revitalization, making it a place of both historical pride and modern ambition.

The city of Philadelphia is home to 159 neighborhoods, the boundaries of which can be seen as shown here :
```{r}
# Set up base map
API_key <- "e1f47dec-6863-4a61-b2cd-e1a5185301b4"
register_stadiamaps(API_key)
phl_map <- get_stadiamap(c(bottom = 39.85, top = 40.14, left = -75.3, right = -74.9), zoom = 12,
                         maptype = 'stamen_toner_lite')
```

```{r, fig.show='hold', message = FALSE, warning = FALSE}
ggmap(phl_map) +
  geom_sf(data = neighborhoods, inherit.aes = FALSE, color = 'black', fill = 'lightblue') +
  theme_minimal() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())
```

This map will serve as a foundation for this project and the following exploratory data analysis. By undertsanding the city's geographic layout and distribution of neighborhood, we can better examine how our factors differ across neighborhoods. 

## Exploring Crime

Philadelphia has long faced challenges with crime, making public safety a key concern for residents and city officials alike. The Philadelphia Police Department (PPD), one of the oldest municipal police forces in the United States, is responsible for maintaining law and order across the city's diverse neighborhoods. Crime rates in Philadelphia have fluctuated over the years, with violent crime, particularly gun violence, being a persistent issue in certain areas. Factors such as socioeconomic conditions, education, and policing strategies all play a role in shaping crime trends throughout the city. While initiatives like community policing and crime prevention programs aim to reduce criminal activity, disparities in crime rates across neighborhoods highlight the need for a data-driven approach to understanding and addressing public safety concerns.

Crime incidents are categorized two different ways by the city of Philadelphia: Part 1 and Part 2. Part 1 crimes are more serious offenses. Part 1 crimes are as follows: Homicide (Criminal), Homicide (Justifiable), Homicide (Gross Negligence), Rape, Robbery Firearm, Robbery No Firearm, Aggravated Assault Firearm, Aggravated Assault No Firearm, Burglary Non-Residential, Burglary Residential, Theft from Vehicle, Retail Theft, Motor Vehicle Theft, and Recovered Stolen Motor Vehicle. Part 2 crimes are less serious offenses. Part 2 crimes are as follows: Other Assaults, Arson, Forgery and Counterfeiting, Fraud, Embezzlement, Recieving Stolen Property, Vandalism/Criminal Mischief, Weapon Violations, Prostitution and Commericalized Vice, Other Sex Offenses, Narcotic/Drug Law Violations, Gambling Violations, Offenses Against Family and Children, DUI, Liquor Law Violations, Drunkenness, Disorderly Conduct, Vagrancy, and All Other Offenses. The top five most commited crimes by Part are as follows: 

```{r}
# Convert crime code to factor
crime <- crime %>% 
  mutate(ucr_general = as.factor(ucr_general))
```

```{r}
top_5_p1 <- crime %>% 
              filter(ucr_general %in% c('100', '200', '300', '400', '600', '700')) %>%
              count(text_general_code) %>%
              arrange(desc(n)) %>%
              head(5)

table1 <- kable(top_5_p1, caption = "Most Committed Part 1 Crimes", col.names = c('Crime', 'Count')) 

top_5_p2 <- crime %>% 
              filter(ucr_general %in% c('800', '900', '1000', '1100', '1200', '1300', '1400', '1500', 
                                        '1600', '1700', '1800', '1900', '2000', '2100', '2200', '2300', 
                                        '2400', '2500', '2600')) %>%
              count(text_general_code) %>%
              arrange(desc(n)) %>%
              head(5)

table2 <- kable(top_5_p2, caption = "Most Committed Part 2 Crimes", col.names = c('Crime', 'Count'))
```

```{r set up tables, echo = FALSE, results = 'asis'}
table1

table2
```

Crime rates often experience a noticeable increase during the summer months, a trend observed in many cities, including Philadelphia. Several factors contribute to this seasonal spike, including warmer weather, longer daylight hours, and increased social interactions, all of which create more opportunities for criminal activity. Schools being out of session can also lead to higher rates of juvenile crime, as young individuals have more free time and fewer structured activities. Additionally, heat has been linked to increased aggression and heightened tensions, which can escalate conflicts and contribute to violent crimes. Law enforcement agencies often anticipate these seasonal fluctuations and may adjust their patrols and crime prevention strategies accordingly to mitigate the surge in incidents. Philadelphia's number of crimes by month in 2023 is shown here :

```{r}
inc_by_month <- crime %>% 
  group_by(month = month(dispatch_date_time)) %>% 
  summarise(n = n()) %>% 
  arrange(month) %>% 
  mutate(month = factor(month, levels = 1:12, labels = month.name))
```

```{r, fig.show='hold', message = FALSE, warning = FALSE}
ggplot(inc_by_month, aes(x = month, y = n)) +
  geom_col(fill = 'lightblue', color = 'black') +
  labs(title = 'Crime Incidents by Month', y = 'Count', x = NULL) +
  theme_minimal()
```

Crime in Philadelphia varies significantly by neighborhood, reflecting differences in socioeconomic conditions, population density, and law enforcement presence. Certain areas, such as Kensington and North Philadelphia, experience higher crime rates, particularly violent crimes, due to factors like poverty, drug activity, and gang presence. In contrast, neighborhoods like Center City and parts of South Philadelphia, while still experiencing crime, tend to have lower rates of violent offenses and more incidents related to property crime or minor offenses. The distribution of crime is also influenced by factors such as proximity to major transit hubs, nightlife areas, and community investment in safety initiatives. Understanding crime patterns at the neighborhood level is crucial for law enforcement, policymakers, and community organizations to develop targeted strategies for crime prevention and public safety improvements. The top ten neighborhoods by total crime incidents are as follows:

```{r}
inc_by_neighborhood <- crime %>% 
  group_by(LISTNAME) %>% 
  summarise(n = n()) %>% 
  arrange(desc(n))
```

```{r, echo = FALSE, results = 'asis'}
kable(inc_by_neighborhood[1:10,], caption = "Top 10 Neighborhoods by Crime Incidents", col.names = c('Neighborhood', 'Count'))
```

And a crime heatmap can be seen here:

```{r}
# Merge crime counts with spatial neighborhood data
neighborhoods_crime <- neighborhoods %>% 
  left_join(inc_by_neighborhood, by = c('LISTNAME' = 'LISTNAME'))

# Convert to df for plot
neighborhoods_crime_df <- fortify(neighborhoods_crime, region = 'Name')
```


```{r, fig.show='hold', message = FALSE, warning = FALSE}
ggplot(data = neighborhoods_crime) +
  geom_sf(data = neighborhoods_crime, aes(fill = n), color = 'black') +
  scale_fill_viridis_c(option = 'magma', na.value = 'gray90') +
  labs(title = 'Crime Heatmap by Neighborhood', fill = 'Count') +
  theme_minimal()
```

## Exploring Schools

The School District of Philadelphia (SDP) is the largest public school system in Pennsylvania, serving over 200,000 students across a diverse and dynamic urban landscape. With a mix of traditional public schools, charter schools, and specialized programs, the district plays a crucial role in shaping educational opportunities for children in the city. However, SDP has long faced challenges related to funding disparities, aging infrastructure, and achievement gaps among students from different socioeconomic backgrounds. Despite these obstacles, the district continues to implement reforms aimed at improving academic performance, increasing graduation rates, and expanding access to quality education. As education is closely linked to broader social and economic outcomes, understanding the strengths and struggles of Philadelphia’s public schools is essential in analyzing larger community trends, including crime and resulting mobility.

Graduation rates are a key metric for assessing school performance and student success. A high school diploma is a critical milestone that opens doors to higher education, career opportunities, and economic stability. Graduation rates can vary significantly across schools and student populations, reflecting differences in academic support, resources, and community factors. Schools with higher graduation rates often have strong leadership, effective teaching practices, and supportive learning environments that help students stay engaged and motivated to complete their education. By analyzing graduation rates by school and demographic group, we can identify patterns, disparities, and areas for improvement within the public school system. Across the city the average four-year graduation rate is 67.3%.

```{r data prep, message = FALSE, warning = FALSE}
schools <- schools %>% 
  filter(!is.na(as.numeric(score))) %>% 
  mutate(score = as.numeric(score))
```


```{r}
avg_grad_rate <- mean(schools$score)
avg_grad_rate
```

The top ten schools by four-year graduation rate are as follows:

```{r, message = FALSE, warning = FALSE}
graduation_rates <- schools %>% 
  summarise(schoolname = schoolname, score = score) %>%
  arrange(desc(as.numeric(score)))
```

```{r, echo = FALSE, results = 'asis'}
kable(graduation_rates[1:10,], caption = "Top 10 Schools by Four-Year Graduation Rate", col.names = c('School', 'Graduation Rate'))
```

Inversely, the lowest ten schools by four-year graduation rate can be seen here:

```{r, message = FALSE, warning = FALSE}
graduation_rates_low <- schools %>% 
  summarise(schoolname = schoolname, score = score) %>%
  arrange(as.numeric(score))
```

```{r, echo = FALSE, results = 'asis'}
kable(graduation_rates_low[1:10,], caption = "Bottom 10 Schools by Four-Year Graduation Rate", col.names = c('School', 'Graduation Rate'))
```

The distribution of graduation rates across schools can be visualized in a histogram:

```{r, fig.show='hold', message = FALSE, warning = FALSE}
ggplot(schools, aes(x = score)) +
  geom_histogram(fill = 'lightblue', color = 'black', bins = 10) +
  labs(title = 'Distribution of Four-Year Graduation Rates', x = 'Graduation Rate', y = 'Count') +
  theme_minimal()
```

As seen in the histogram, graduation rates among Philadelphia schools vary widely, with some schools achieving high rates of success while others struggle to graduate students on time. Factors such as school leadership, teacher quality, student engagement, and community support all play a role in determining graduation outcomes. Schools with lower graduation rates may face challenges related to student retention, academic performance, and social-emotional support, highlighting the need for targeted interventions and resources to help students succeed. By analyzing graduation rates at the school level, we can identify areas for improvement and develop strategies to increase student achievement and promote educational equity across the city.

The distribution of these schools across the city as well as a heatmap of their four-year graduation rates can be seen here:

```{r}
# Split out the GPS coordinates
schools <- schools %>%
  mutate(geometry = gsub("c\\(|\\)", "", geometry)) %>%
  separate(geometry, into = c("lat", "long"), sep = ", ", convert = TRUE) %>% 
  st_as_sf(coords = c("lat", "long"), crs = 4326)
```

```{r, fig.show='hold', message = FALSE, warning = FALSE}
grad_rate_map <- ggmap(phl_map) +
  geom_point(data = schools, aes(x = st_coordinates(geometry)[,1], 
                                 y = st_coordinates(geometry)[,2], 
                                 color = score), 
             size = 3) +
  scale_color_viridis_c(option = 'magma', na.value = 'gray90') +
  labs(color = 'Graduation Rate') +
  theme_minimal()

grad_rate_map
```

It is important to understand how schools perform based on the location that they are in. By understanding the distribution of schools and their graduation rates, we can better understand how schools are performing in different neighborhoods. The top 5 neighborhoods by average graduation rate are as follows:

```{r}
grad_by_neighborhood_high <- schools %>% 
  group_by(LISTNAME) %>% 
  summarise(avg_score = mean(score),
            num_schools = n()) %>% 
  arrange(desc(avg_score)) %>% 
  head(5) %>% 
  st_drop_geometry()
```

```{r, echo = FALSE, results = 'asis'}
kable(grad_by_neighborhood_high, caption = "Top 5 Neighborhoods by Average Graduation Rate", 
      col.names = c('Neighborhood', 'Average Graduation Rate', 'Number of Schools'))
```

And the bottom 5 neighborhoods by average graduation rate are as follows:

```{r}
grad_by_neighborhood_low <- schools %>% 
  group_by(LISTNAME) %>% 
  summarise(avg_score = mean(score),
            num_schools = n()) %>% 
  arrange(avg_score) %>% 
  head(5) %>% 
  st_drop_geometry()
```

```{r, echo = FALSE, results = 'asis'}
kable(grad_by_neighborhood_low, caption = "Bottom 5 Neighborhoods by Average Graduation Rate", 
      col.names = c('Neighborhood', 'Average Graduation Rate', 'Number of Schools'))
```

A heatmap of the average graduation rates by neighborhood can be seen here:

```{r, fig.show='hold', message = FALSE, warning = FALSE}
grad_by_neighborhood <- schools %>% 
  group_by(LISTNAME) %>% 
  summarise(avg_score = mean(score)) %>% 
  st_drop_geometry()

# Merge graduation rates with spatial neighborhood data
neighborhoods_grad <- neighborhoods %>% 
  left_join(grad_by_neighborhood, by = c('LISTNAME' = 'LISTNAME'))

# Convert to df for plot
neighborhoods_grad_df <- fortify(neighborhoods_grad, region = 'Name')

ggplot(data = neighborhoods_grad) +
  geom_sf(data = neighborhoods_grad, aes(fill = avg_score), color = 'black') +
  scale_fill_viridis_c(option = 'magma', na.value = 'gray90') +
  labs(title = 'Graduation Rate Heatmap by Neighborhood', fill = 'Average Graduation Rate') +
  theme_minimal()
```

Now that there is a good understanding of the city of Philadelphia, the distribution of crime and schools, and the relationship between schools and crime, we can move on to the analysis of the relationship between the two.

# Regressions

We are going to start by running a simple regression to see if there is a relationship between a school's graduation rate and the total number of crimes within a 1-mile radius of the school.

```{r, eval=FALSE}
model1 <- lm(as.numeric(score) ~ crime_total, data = school_crime_features)
summary(model1)
```

The results of the simple regression show that there is not a significant relationship between a school's graduation rate and the total number of crimes within a 1-mile radius of the school. The p-value for the crime_total variable is 0.37, which is above the typical threshold of 0.05 for statistical significance. This suggests that the number of crimes near a school does not have a strong impact on the school's graduation rate. However, it is important to note that this is a simple regression model and does not account for other potential factors that could influence the relationship between crime and education.

```{r}
# Load datasets (update file paths as needed)
crime_data <- read.csv("data/raw/crime-incidents-2023.csv")
school_data <- read.csv("data/clean/school_data.csv")

# Remove missing values
crime_data <- na.omit(crime_data)
school_data <- na.omit(school_data)

# Aggregate Crime Data by School Location
# Create a matrix of crime type counts within a 1-mile radius of each school

# Function to count crimes within 1-mile (~0.016 degrees) radius per school
count_crimes_near_school <- function(lat, lon, crime_df) {
  crime_subset <- crime_df %>%
    filter(sqrt((lat - crime_df$lat)^2 + (lon - crime_df$lng)^2) < 0.016)
  return(nrow(crime_subset))
}

school_data$crime_count <- mapply(count_crimes_near_school, school_data$lat, school_data$long, MoreArgs = list(crime_df = crime_data))

# Dummy Variable Crime Categories
crime_data$crime_type <- as.factor(crime_data$text_general_code)
crime_matrix <- model.matrix(~ crime_type - 1, data = crime_data)  # Dummy encoding

# Aggregate the one-hot encoded crimes by school proximity
school_crime_features <- school_data %>%
  select(schoolname, lat, long, score) %>%
  mutate(crime_total = school_data$crime_count)

# Add aggregated crime types per school
for (crime_col in colnames(crime_matrix)) {
  school_crime_features[[crime_col]] <- sapply(1:nrow(school_data), function(i) {
    lat <- school_data$lat[i]
    lon <- school_data$long[i]
    sum(crime_matrix[sqrt((crime_data$lat - lat)^2 + (crime_data$lng - lon)^2) < 0.016, crime_col])
  })
}
```

```{r, eval=FALSE}
# Prepare X matrix and y for Regression
X <- as.matrix(school_crime_features %>% select(-schoolname, -lat, -long, -score))
y <- as.numeric(school_crime_features$score)

# Standardize Features
X_scaled <- scale(X)

# LASSO Regression with Cross-Validation
# Ensure y (graduation rate) is numeric
y <- as.numeric(school_crime_features$score)

# Remove rows where y is NA
valid_rows <- !is.na(y)
X_scaled <- X_scaled[valid_rows, , drop = FALSE]
y <- y[valid_rows]

# Ensure y has variation
if (var(y) == 0) {
  stop("Error: y has no variation. Check data preprocessing.")
}

# Run LASSO Regression
set.seed(15)
lasso_model <- cv.glmnet(X_scaled, y, alpha = 1, nfolds = 10)  # LASSO (alpha = 1)
plot(lasso_model)

# Get selected features from LASSO
coef_lasso <- coef(lasso_model, s = "lambda.1se")
selected_lasso <- coef_lasso[which(coef_lasso != 0), , drop = FALSE]
#print(selected_lasso)
```

```{r, eval=FALSE}
# Ridge Regression to see if the shrinking has any effect
set.seed(15)
ridge_model <- cv.glmnet(X_scaled, y, alpha = 0, nfolds = 10)  # Ridge (alpha = 0)
plot(ridge_model)

# Get coefficients from Ridge Regression
coef_ridge <- coef(ridge_model, s = "lambda.1se")
selected_ridge <- coef_ridge[which(abs(coef_ridge) > 0.01), , drop = FALSE]
print(selected_ridge)
```

```{r need this for logistic to run, eval=FALSE}
# Load datasets
crime_data <- read.csv("data/raw/crime-incidents-2023.csv")
school_data <- read.csv("data/clean/school_data.csv")

table(crime_data$text_general_code)  # Checking crime categories

# Define binary graduation rate variable (High = 1, Low = 0)
graduation_threshold <- 80  # Example threshold for high graduation rate
school_data$High_Grad <- ifelse(as.numeric(school_data$score) >= graduation_threshold, 1, 0)

# Define crime categories
violent_crimes <- c("Homicide", "Aggravated Assault", "Robbery", "Rape")
crime_data$Violent <- ifelse(crime_data$text_general_code %in% violent_crimes, 1, 0)

# Remove rows with missing latitude or longitude
crime_data <- crime_data %>% drop_na(lat, lng)

# Convert to spatial data frames
crime_sf <- st_as_sf(crime_data, coords = c("lng", "lat"), crs = 4326)
school_sf <- st_as_sf(school_data, coords = c("long", "lat"), crs = 4326)

# Buffer schools to create a 1 km radius for crime aggregation
school_buffers <- st_buffer(school_sf, dist = 1000)  # 1000 meters = 1 km

#Spatial join: Count crimes within each school’s buffer
crime_counts <- st_join(school_buffers, crime_sf) %>%
  group_by(schoolid_ulcs) %>%
  summarize(
    Violent_Crime_Rate = mean(Violent, na.rm = TRUE),
    Non_Violent_Crime_Rate = 1 - mean(Violent, na.rm = TRUE),
    Total_Crime = n()
  )
```


```{r, eval=FALSE}
# Merge school data with aggregated crime data
merged_data <- school_data %>%
  left_join(crime_counts, by = "schoolid_ulcs") %>%
  drop_na()

# Split into training and testing sets
set.seed(123)
train_index <- createDataPartition(merged_data$High_Grad, p = 0.7, list = FALSE)
train_data <- merged_data[train_index, ]
test_data <- merged_data[-train_index, ]

# Fit logistic regression model
logit_model <- glm(High_Grad ~ Violent_Crime_Rate + Total_Crime, 
                   data = train_data, family = binomial)
summary(logit_model)

# Make predictions
pred_probs <- predict(logit_model, newdata = test_data, type = "response")
test_data$Predicted <- ifelse(pred_probs > 0.5, 1, 0)

# Evaluate model performance
conf_matrix <- confusionMatrix(factor(test_data$Predicted), factor(test_data$High_Grad))
print(conf_matrix)

# ROC Curve and AUC
roc_curve <- roc(test_data$High_Grad, pred_probs)
plot(roc_curve, col = "blue", main = "ROC Curve")
auc(roc_curve)
```

```{r, eval=FALSE}
#Just a quick regression on 50% graduation rate.

# Merge school data with aggregated crime data
merged_data <- school_data %>%
  left_join(crime_counts, by = "schoolid_ulcs") %>%
  drop_na()

# Split into training and testing sets
set.seed(123)
train_index <- createDataPartition(merged_data$High_Grad, p = 0.5, list = FALSE)
train_data <- merged_data[train_index, ]
test_data <- merged_data[-train_index, ]

# Fit logistic regression model
logit_model <- glm(High_Grad ~ Violent_Crime_Rate + Total_Crime, 
                   data = train_data, family = binomial)
summary(logit_model)

# Make predictions
pred_probs <- predict(logit_model, newdata = test_data, type = "response")
test_data$Predicted <- ifelse(pred_probs > 0.5, 1, 0)

# Evaluate model performance
conf_matrix <- confusionMatrix(factor(test_data$Predicted), factor(test_data$High_Grad))
print(conf_matrix)

# ROC Curve and AUC
roc_curve <- roc(test_data$High_Grad, pred_probs)
plot(roc_curve, col = "blue", main = "ROC Curve")
auc(roc_curve)
```

We then investigated whether violent and non-violent crime rates influence the likelihood of a school achieving a high graduation rate (above 70%). A logistic regression model was applied to predict the likelihood of a school achieving a high graduation rate based on the independent variables of violent crime rate and total crime (which includes both violent and non-violent offenses). The dependent variable, High_Grad, is a binary indicator representing whether a school has a high graduation rate (>70%).

The results of the analysis indicate that none of the predictors were statistically significant (p > 0.05), likely due to the limited number of variables included in the model. The Akaike Information Criterion (AIC) for the model was 78.446, providing a measure of model fit relative to other possible models. The model predicts probabilities for High_Grad with a classification threshold of 0.7, meaning that a probability greater than or equal to 0.5 is classified as 1 (high graduation rate), while probabilities below 0.7 are classified as 0. Although an increase in violent crime rate appears to reduce the odds of achieving a high graduation rate, the p-value (0.210) indicates that this effect is not statistically significant. As a result, we cannot confidently conclude that violent crime has a real impact on graduation rates.

On top of that, the confusion matrix provides insight into the performance in predicting whether a school has a high graduation rate. The model correctly identified 18 low-graduation schools (true negatives) and 2 high-graduation schools (true positives). However, it also misclassified 17 high-graduation schools as low-graduation (false negatives) and incorrectly predicted 1 low-graduation school as high-graduation (false positive). This results in an accuracy of 52.63%, which is only slightly better than random guessing. The model demonstrates high specificity (94.74%), meaning it is very effective at correctly identifying low-graduation schools. However, its sensitivity is extremely low (10.53%), indicating that it fails to correctly identify most high-graduation schools. In other words, when a school truly has a high graduation rate, the model only detects it 10.53% of the time, making it unreliable for identifying high-performing schools.

Additionally, the precision (66.67%) suggests that when the model does predict a high graduation rate, it is correct about two-thirds of the time. However, the high number of false negatives significantly impacts its usefulness, as many high-graduation schools are being misclassified as low-graduation. The model is heavily biased towards predicting low-graduation schools correctly

The analysis suggests that while there may be a negative relationship between violent crime and high school graduation rates, the current model does not provide statistically significant evidence to support this claim. The lack of significance could be attributed to a limited number of predictor variables, potential non-linear relationships not captured in the model, or the need for additional socioeconomic factors to enhance predictive accuracy. To improve the model and gain better insights, we recommend incorporating additional predictors, such as school funding, poverty rates, and student-teacher ratios. Furthermore, exploring non-linear regression techniques or machine learning models may help capture more complex relationships, and increasing the sample size could improve statistical power. Further research with expanded datasets and alternative modeling approaches could yield more conclusive findings on the impact of crime rates on educational outcomes.

# Conclusion

## Future Work

In a perfect world, we have access to as much data as we would like, whenever we would like it. Unfortunately, due to plenty of constraints, things do not work that way. In the future, we would like to have access to more data to better understand the relationship between crime and education in Philadelphia. This could include data on school funding, student-teacher ratios, poverty rates, and other socioeconomic factors that could influence educational outcomes. By expanding the scope of the analysis and incorporating more data sources, we can gain deeper insights into the factors that impact crime rates and graduation rates in Philadelphia, ultimately informing policy decisions and interventions to improve public safety and educational outcomes in the city.

## Final Statement

In conclusion, this project aimed to explore the relationship between crime rates and school performance in Philadelphia. By analyzing crime incidents and school graduation rates, we sought to identify patterns, trends, and potential correlations between these two critical aspects of urban life. Through exploratory data analysis and various types of regression models, we gained insights into the distribution of crime, school performance metrics, and their spatial relationships across neighborhoods in Philadelphia. While our initial regression models did not yield statistically significant results, they provided a foundation for further research and analysis to better understand the complex interplay between crime and education in the city.

\pagebreak
# Appendix {-}

## Data dictionary

A detailed summary of the variables in each data set follows:

### OpenData Philly - Uncleaned Datasets

#### Crime Incidents \newline

*Source:* https://metadata.phila.gov/#home/datasetdetails/5543868920583086178c4f8e/representationdetails/570e7621c03327dc14f4b68d/?view_287_page=1 

*Description:* Part 1 & Part 2 Crime Incidents from the Police Department's INCT system with generalized UCR codes and addresses rounded to the hundred block. These counts may not coincide exactly with data that is submitted to the Uniformed Crime Reporting (UCR) system.

* the_geom - Unique identifier
* cartodb_id - Unique identifier
* the_geom_webmercator - Unique identifier
* objectid - Unique identifier
* dc_dist - A two character field that names the District boundary
* psa - A single character field that names the Police Service Area Boundary
* dispatch_date_time - The date and time that the officer was dispatched to the scene
* dispatch_date - Dispatch date formatted as a string
* dispatch_time - Dispatch time formatted as a string
* hour_ - The generalized hour of the dispatched time
* dc_key - The unique identifier of the crime that consists of Year + District + Unique ID
* location_block - The location of crime generalized by street block
* ucr_general - The rounded crime code
* text_general_code - The generalized text for the crime code
* point_x - Longitude of crime location
* point_y - Latitude of crime location
* lat - Latitude of crime location
* lng - Longitude of crime location

#### School Department of Philadelphia \newline

*Source:* https://www.philasd.org/research/#opendata

*Description:* This longitudinal open data file includes information about the graduation rates for schools broken out by: graduation rate type (four-year, five-year, or six-year), demographic category (EL status, IEP status, Economically Disadvantaged Status, Gender, or Ethnicity), and 9th grade cohort. Students are attributed to the last school at which they actively attended in the respective graduation window, which ends on September 30 each year. Students are classified as EL, as having an IEP, and/or economically disadvantaged if they were designated as such at any point during their high school career.

* cohort - School year that freshman began
* schoolid_ulcs - Unique school identifier
* school_name - School name
* sector - Type of school (Two levels - District and Alternative)
* rate_type - Graduation rate type
* group - Grouping of students
* subgroup - Subgrouping of students
* denom - Number of students in cohort
* num - Number of students that graduated in cohort
* score - Percentage of students that graduated in cohort
* lat - Latitude of school location
* long - Longitude of crime location

#### Neighborhood GeoJSON \newline

*Source:* https://opendataphilly.org/datasets/philadelphia-neighborhoods/

*Description:* This dataset includes neighborhood boundaries for 150+ neighborhoods in Philadelphia. The data was gathered from a mix of publicly available maps, including from the City of Philadelphia, the City Archives, the Philadelphia Inquirer, and user feedback.

* NAME - Neighborhood name
* LISTNAME - Neighborhood name
* MAPNAME - Neighborhood name
* Shape_Leng - Length of shape of neighborhood boundary
* Shape_Area - Total area inside shape of neighborhood
* geometry - Polygon coordinates of neighborhood boundary

### Team One Data - Cleaned Datasets

#### Crime Incidents by Neighborhood \newline

*Description:* This clean dataset contains crime incident records from 2023 categorized by neighborhood, including details on crime type, date, location, and police district, making it useful for analyzing spatial and temporal crime patterns.

* the_geom - Unique identifier
* cartodb_id - Unique identifier
* the_geom_webmercator - Unique identifier
* objectid - Unique identifier
* dc_dist - A two character field that names the District boundary
* psa - A single character field that names the Police Service Area Boundary
* dispatch_date_time - The date and time that the officer was dispatched to the scene
* dispatch_date - Dispatch date formatted as a string
* dispatch_time - Dispatch time formatted as a string
* hour_ - The generalized hour of the dispatched time
* dc_key - The unique identifier of the crime that consists of Year + District + Unique ID
* location_block - The location of crime generalized by street block
* ucr_general - The rounded crime code
* text_general_code - The generalized text for the crime code
* point_x - Longitude of crime location
* point_y - Latitude of crime location
* NAME - Neighborhood name
* LISTNAME - Neighborhood name
* MAPNAME - Neighborhood name
* Shape_Leng - Length of shape of neighborhood boundary
* Shape_Area - Total area inside shape of neighborhood
* geometry - Polygon coordinates of neighborhood boundary


#### School Data \newline

*Description:* This clean dataset contains school performance metrics from 2023, including four year graduation rates by school, sector, and demographic group, along with geographical coordinates for spatial analysis.

* cohort - School year that freshman began
* schoolid_ulcs - Unique school identifier
* school_name - School name
* sector - Type of school (Two levels - District and Alternative)
* rate_type - Graduation rate type
* group - Grouping of students
* subgroup - Subgrouping of students
* denom - Number of students in cohort
* num - Number of students that graduated in cohort
* score - Percentage of students that graduated in cohort
* lat - Latitude of school location
* long - Longitude of crime location

#### School Data with Neighborhood \newline

*Description:* This clean dataset contains school performance metrics from 2023, including four year graduation rates by school, sector, and demographic group, along with geographical coordinates for spatial analysis and neighborhood information.

* cohort - School year that freshman began
* schoolid_ulcs - Unique school identifier
* school_name - School name
* sector - Type of school (Two levels - District and Alternative)
* rate_type - Graduation rate type
* group - Grouping of students
* subgroup - Subgrouping of students
* denom - Number of students in cohort
* num - Number of students that graduated in cohort
* score - Percentage of students that graduated in cohort
* NAME - Neighborhood name
* LISTNAME - Neighborhood name
* MAPNAME - Neighborhood name
* Shape_Leng - Length of shape of neighborhood boundary
* Shape_Area - Total area inside shape of neighborhood
* geometry - Coordinates of school location

## Data Prep for EDA

The type of crime is very important for grouping incidents. UCR code is grouped as a factor for easier analysis.

```{r, echo=TRUE, eval=FALSE}
# Convert crime code to factor
crime <- crime %>% 
  mutate(ucr_general = as.factor(ucr_general))
```

Some of the school scores are missing, so any that cannot be converted to numeric will be removed.

```{r, echo=TRUE, eval=FALSE}
# Filter schools where 'score' is numeric
schools <- schools %>% 
  filter(!is.na(as.numeric(score))) %>% 
  mutate(score = as.numeric(score))
```

In order to plot, the school's GPS coordinates have to be split.

```{r, echo=TRUE, eval=FALSE}
# Split out the GPS coordinates
schools <- schools %>%
  mutate(geometry = gsub("c\\(|\\)", "", geometry)) %>%
  separate(geometry, into = c("lat", "long"), sep = ", ", convert = TRUE) %>% 
  st_as_sf(coords = c("lat", "long"), crs = 4326)
```


## Data cleaning process

### Putting crime incidents into neighborhoods

In order to analyze crime incidents by neighborhood, we needed to spatially join the crime incidents data with the neighborhood boundaries. This was done using the `sf` package in R. The process involved reading in the neighborhood boundaries and crime incidents data, converting the crime incidents to spatial points, and then performing a spatial join to assign each crime incident to a neighborhood. The resulting dataset was then saved as a new CSV file for further analysis.

```{r, echo=TRUE, eval=FALSE}
# Load in data
neighborhood <- st_read('data/philadelphia-neighborhoods.geojson')
crime <- read.csv('data/crime-incidents-2023.csv')

# Filter out missing coordinates in crime
crime <- crime %>% filter(!is.na(lat) & !is.na(lng))

# Convert crime to sf
crime_sf <- st_as_sf(crime, coords = c('lng', 'lat'), crs = 4326)

# Make sure both have same CRS
neighborhood <- st_make_valid(neighborhood)

# Simplify geometries
neighborhood <- st_simplify(neighborhood, dTolerance = 0.001)

# Spatial join to get neighborhood for each crime
crime_w_neighborhoods <- st_join(crime_sf, neighborhood, join = st_intersects)

# Save to a new csv
#write.csv(crime_w_neighborhoods, 'data/crime-by-neighborhood.csv')
```

### Combining school coordinates with graduation rates

In order to begin working with the school data, we had to combine the school coordinates with the graduation rates. This was done by reading in the school list and graduation rates data, joining them on the school ID, and then splitting the GPS coordinates into separate latitude and longitude columns. Also, given time constraints on this project, the dataset was reduced to only include four year graduation rates. The resulting dataset was then saved as a new CSV file for further analysis.

```{r, echo=TRUE, eval=FALSE}
# Load in files we need
grad_rates <- read.csv('data/SDP_Graduation_rates_school_S_2024-04-01.csv')
school_list <- read.csv('data/2022-2023 Master SChool List (20230110).csv')

# First, let's clean up the graduation rates
# We only want the graduating class of 2023, 4 year grad rates, for all students
grad_rates <- grad_rates %>% 
  filter(cohort == '2019-2020',
         rate_type == '4-Year Graduation Rate',
         group == 'All Students')

# Next let's bring in the latitude and longitude from the school list
school_data <- grad_rates %>% 
  left_join(school_list %>% select('ULCS.Code', 'GPS.Location'),
            by = c('schoolid_ulcs' = 'ULCS.Code'))

# Split up GPS into lat and long
school_data <- school_data %>% 
  separate(GPS.Location, c('lat', 'long'), sep = ', ', convert = TRUE)
           
# Drop empty coordinate
school_data <- school_data %>% 
  filter(!is.na(lat))
           
# Save as csv
#write.csv(school_data, 'data/school_data.csv', row.names = FALSE)
```

## Putting schools into neighborhoods

```{r, echo=TRUE, eval=FALSE}
# Merge school locations with spatial neighborhood data
# Filter out missing coordinates in schools
schools <- schools %>% filter(!is.na(lat) & !is.na(long))

# Convert crime to sf
schools_sf <- st_as_sf(schools, coords = c('long', 'lat'), crs = 4326)

# Make sure both have same CRS
neighborhoods <- st_make_valid(neighborhoods)

# Simplify geometries
neighborhoods <- st_simplify(neighborhoods, dTolerance = 0.001)

# Spatial join to get neighborhood for each crime
schools_w_neighborhoods <- st_join(schools_sf, neighborhoods, join = st_intersects)

# Save to a new csv
#write.csv(schools_w_neighborhoods, 'data/crime-by-neighborhood.csv')
```

## Aggregate Crime Data By School Location

```{r, echo=TRUE, eval=FALSE}
# Load datasets (update file paths as needed)
crime_data <- read.csv("data/raw/crime-incidents-2023.csv")
school_data <- read.csv("data/clean/school_data.csv")

# Remove missing values
crime_data <- na.omit(crime_data)
school_data <- na.omit(school_data)

# Aggregate Crime Data by School Location
# Create a matrix of crime type counts within a 1-mile radius of each school

# Function to count crimes within 1-mile (~0.016 degrees) radius per school
count_crimes_near_school <- function(lat, lon, crime_df) {
  crime_subset <- crime_df %>%
    filter(sqrt((lat - crime_df$lat)^2 + (lon - crime_df$lng)^2) < 0.016)
  return(nrow(crime_subset))
}

school_data$crime_count <- mapply(count_crimes_near_school, school_data$lat, school_data$long, MoreArgs = list(crime_df = crime_data))

# Dummy Variable Crime Categories
crime_data$crime_type <- as.factor(crime_data$text_general_code)
crime_matrix <- model.matrix(~ crime_type - 1, data = crime_data)  # Dummy encoding

# Aggregate the one-hot encoded crimes by school proximity
school_crime_features <- school_data %>%
  select(schoolname, lat, long, score) %>%
  mutate(crime_total = school_data$crime_count)

# Add aggregated crime types per school
for (crime_col in colnames(crime_matrix)) {
  school_crime_features[[crime_col]] <- sapply(1:nrow(school_data), function(i) {
    lat <- school_data$lat[i]
    lon <- school_data$long[i]
    sum(crime_matrix[sqrt((crime_data$lat - lat)^2 + (crime_data$lng - lon)^2) < 0.016, crime_col])
  })
}
```

## Create Crime Counts for Logistic Regression
```{r, echo=TRUE, eval=FALSE}
# Load datasets
crime_data <- read.csv("data/raw/crime-incidents-2023.csv")
school_data <- read.csv("data/clean/school_data.csv")

table(crime_data$text_general_code)  # Checking crime categories

# Define binary graduation rate variable (High = 1, Low = 0)
graduation_threshold <- 80  # Example threshold for high graduation rate
school_data$High_Grad <- ifelse(as.numeric(school_data$score) >= graduation_threshold, 1, 0)

# Define crime categories
violent_crimes <- c("Homicide", "Aggravated Assault", "Robbery", "Rape")
crime_data$Violent <- ifelse(crime_data$text_general_code %in% violent_crimes, 1, 0)

# Remove rows with missing latitude or longitude
crime_data <- crime_data %>% drop_na(lat, lng)

# Convert to spatial data frames
crime_sf <- st_as_sf(crime_data, coords = c("lng", "lat"), crs = 4326)
school_sf <- st_as_sf(school_data, coords = c("long", "lat"), crs = 4326)

# Buffer schools to create a 1 km radius for crime aggregation
school_buffers <- st_buffer(school_sf, dist = 1000)  # 1000 meters = 1 km

#Spatial join: Count crimes within each school’s buffer
crime_counts <- st_join(school_buffers, crime_sf) %>%
  group_by(schoolid_ulcs) %>%
  summarize(
    Violent_Crime_Rate = mean(Violent, na.rm = TRUE),
    Non_Violent_Crime_Rate = 1 - mean(Violent, na.rm = TRUE),
    Total_Crime = n()
  )
```

